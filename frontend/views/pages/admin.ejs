<%- include('../partials/header', { title: 'Editorial Suite' }) %>

<style>
  :root {
    --brand-green: #1a3c31;
    --brand-gold: #b59b5d;
    --bg-light: #f9fbff;
    --border-light: #edf2f7;
    --text-muted: #64748b;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, var(--bg-light) 0%, #f0f4f8 100%); color: var(--text-muted); min-height: 100vh; margin-top: 4.5rem; }

  .editorial-wrapper { max-width: 960px; margin: 40px auto; padding: 0 20px 60px; }

  /* Header */
  .editorial-header { margin-bottom: 36px; }
  .header-title { font-family: 'Sora', sans-serif; font-size: 2.4rem; font-weight: 700; color: var(--brand-green); letter-spacing: -0.5px; }
  .header-subtitle { color: var(--text-muted); font-size: 1rem; margin-top: 6px; }
  .header-divider { height: 3px; background: linear-gradient(90deg, var(--brand-green), var(--brand-gold)); border-radius: 2px; margin-top: 18px; }

  /* Form card */
  .editorial-form { background: white; border-radius: 20px; padding: 40px; border: 1px solid var(--border-light); box-shadow: 0 10px 30px rgba(0,0,0,0.05); }

  /* Section dividers inside form */
  .form-section-title {
    font-size: 0.7rem; font-weight: 800; color: var(--brand-green);
    text-transform: uppercase; letter-spacing: 0.12em;
    margin: 32px 0 20px; padding-bottom: 10px;
    border-bottom: 1px solid var(--border-light);
    display: flex; align-items: center; gap: 8px;
  }
  .form-section-title:first-child { margin-top: 0; }

  .form-group { margin-bottom: 24px; }
  .form-label { display: block; font-size: 0.75rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 10px; }
  .form-control { width: 100%; padding: 13px 16px; border: 1.5px solid var(--border-light); border-radius: 12px; font-family: 'Inter', sans-serif; font-size: 0.95rem; color: #1e293b; transition: all 0.3s ease; background: white; }
  .form-control:focus { border-color: var(--brand-gold); box-shadow: 0 0 0 3px rgba(181,155,93,0.1); outline: none; }
  .form-control::placeholder { color: #cbd5e1; }

  .form-row { display: flex; gap: 18px; margin-bottom: 24px; }
  .form-row .form-group { flex: 1; margin-bottom: 0; }

  /* Textarea with formatting toolbar */
  .textarea-wrap { position: relative; }
  .format-toolbar {
    display: flex; gap: 4px; flex-wrap: wrap;
    padding: 8px 12px; background: #f8fafc;
    border: 1.5px solid var(--border-light); border-radius: 12px 12px 0 0;
    border-bottom: none;
  }
  .fmt-btn {
    padding: 5px 10px; border: 1px solid #e2e8f0; border-radius: 6px;
    background: white; font-size: 0.8rem; cursor: pointer;
    color: #374151; font-family: 'Inter', sans-serif; font-weight: 600;
    transition: all 0.15s; line-height: 1;
  }
  .fmt-btn:hover { background: var(--brand-green); color: white; border-color: var(--brand-green); }
  .fmt-btn.active { background: var(--brand-green); color: white; border-color: var(--brand-green); }
  textarea.form-control.with-toolbar { border-radius: 0 0 12px 12px; min-height: 280px; line-height: 1.6; resize: vertical; font-family: 'Inter', monospace; font-size: 0.93rem; }
  
  .content-hint { font-size: 0.75rem; color: #94a3b8; margin-top: 6px; }

  /* Image preview */
  .img-preview-wrap { margin-top: 10px; display: none; }
  .img-preview-wrap.show { display: block; }
  .img-preview {
    width: 100%; height: 180px; object-fit: cover;
    border-radius: 10px; border: 1.5px solid var(--border-light);
    background: #f1f5f9;
  }
  .img-preview-placeholder {
    width: 100%; height: 120px; border-radius: 10px;
    border: 1.5px dashed var(--border-light); background: #f8fafc;
    display: flex; align-items: center; justify-content: center;
    color: #cbd5e1; font-size: 0.85rem; gap: 8px;
  }

  /* Category select */
  select.form-control { cursor: pointer; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2394a3b8' d='M6 8L1 3h10z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 14px center; padding-right: 36px; }

  /* NJ link field highlight */
  .nj-field .form-control { border-color: rgba(181,155,93,0.4); background: #fffdf7; }
  .nj-field .form-control:focus { border-color: var(--brand-gold); }
  .nj-badge { display: inline-flex; align-items: center; gap: 6px; background: linear-gradient(135deg, var(--brand-green), #2d5e4f); color: white; font-size: 0.7rem; font-weight: 700; padding: 3px 10px; border-radius: 20px; margin-left: 8px; letter-spacing: 0.5px; vertical-align: middle; }

  /* Buttons */
  .button-group { display: flex; gap: 14px; margin-top: 36px; }
  .btn-primary-custom { flex: 1; background: linear-gradient(135deg, var(--brand-green), #2d5e4f); color: white; padding: 16px 32px; border: none; border-radius: 12px; font-weight: 700; font-size: 0.95rem; letter-spacing: 0.5px; cursor: pointer; transition: all 0.3s ease; text-transform: uppercase; box-shadow: 0 4px 15px rgba(26,60,49,0.15); font-family: 'Inter', sans-serif; }
  .btn-primary-custom:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(26,60,49,0.25); }
  .btn-secondary-custom { flex: 0 0 110px; background: white; color: var(--brand-green); padding: 16px 20px; border: 2px solid var(--brand-green); border-radius: 12px; font-weight: 700; font-size: 0.9rem; cursor: pointer; transition: all 0.3s ease; font-family: 'Inter', sans-serif; }
  .btn-secondary-custom:hover { background: #f9fbff; }

  /* Status */
  .status-message { padding: 14px 18px; border-radius: 12px; margin-bottom: 20px; display: none; font-weight: 500; border-left: 4px solid; font-size: 0.95rem; }
  .status-message.success { background: #dcfce7; color: #166534; border-left-color: #16a34a; display: block; }
  .status-message.error   { background: #fee2e2; color: #991b1b; border-left-color: #dc2626; display: block; }

  /* Footer */
  .editorial-footer { text-align: center; margin-top: 28px; padding-top: 28px; border-top: 1px solid var(--border-light); }
  .footer-link { color: var(--brand-gold); text-decoration: none; font-weight: 600; font-size: 0.9rem; }
  .footer-link:hover { color: var(--brand-green); text-decoration: underline; }

  /* Preview panel */
  .preview-toggle { display: flex; align-items: center; gap: 8px; margin-bottom: 20px; cursor: pointer; user-select: none; }
  .preview-toggle input[type="checkbox"] { width: 16px; height: 16px; accent-color: var(--brand-green); cursor: pointer; }
  .preview-toggle label { font-size: 0.85rem; font-weight: 600; color: var(--text-muted); cursor: pointer; }
  .content-preview { display: none; padding: 20px; border: 1.5px solid var(--border-light); border-radius: 12px; background: #fafbfc; min-height: 100px; line-height: 1.8; font-size: 0.95rem; color: #1e293b; }
  .content-preview.show { display: block; }
  .content-preview h2 { font-size: 1.3rem; font-weight: 700; color: var(--brand-green); margin-bottom: 12px; }
  .content-preview h3 { font-size: 1.1rem; font-weight: 700; color: var(--brand-green); margin-bottom: 10px; }
  .content-preview ul, .content-preview ol { padding-left: 20px; margin-bottom: 12px; }
  .content-preview li { margin-bottom: 4px; }
  .content-preview strong { color: #1e293b; }

  @media (max-width: 768px) {
    .header-title { font-size: 1.8rem; }
    .editorial-form { padding: 24px; }
    .form-row { flex-direction: column; gap: 0; }
    .button-group { flex-direction: column; }
    .btn-secondary-custom { flex: 1; }
  }
</style>

<div class="editorial-wrapper">
  <div class="editorial-header">
    <h1 class="header-title">Market Insights</h1>
    <p class="header-subtitle">Publish investment analysis &amp; newsletter content</p>
    <div class="header-divider"></div>
  </div>

  <div class="editorial-form">
    <div id="statusMessage" class="status-message"></div>

    <!-- ‚îÄ‚îÄ SECTION 1: Core Content ‚îÄ‚îÄ -->
    <div class="form-section-title">üì∞ Core Content</div>

    <div class="form-group">
      <label class="form-label">Headline</label>
      <input type="text" id="blogTitle" class="form-control" placeholder="e.g., Why Flexicap Funds Beat Midcap in 2025" required>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Category</label>
        <select id="blogCategory" class="form-control">
          <option value="">‚Äî Select Category ‚Äî</option>
          <option value="SIP">SIP</option>
          <option value="Retirement">Retirement</option>
          <option value="Tax">Tax Savings</option>
          <option value="Market Insight">Market Insight</option>
          <option value="Mutual Fund">Mutual Fund</option>
          <option value="Goal Planning">Goal Planning</option>
          <option value="Market Update">Market Update</option>
        <option value="Risk & Planning">Risk & Planning</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Reference / Source Link</label>
        <input type="url" id="refLink" class="form-control" placeholder="https://economictimes.com/...">
      </div>
    </div>

    <!-- ‚îÄ‚îÄ SECTION 2: Article Content ‚îÄ‚îÄ -->
    <div class="form-section-title">üìù Article Content</div>

    <div class="form-group">
      <label class="form-label">Content <span style="color:#94a3b8;font-weight:400;text-transform:none;letter-spacing:0;">(supports basic HTML)</span></label>
      <div class="textarea-wrap">
        <div class="format-toolbar">
          <button class="fmt-btn" onclick="fmt('bold')" title="Bold"><b>B</b></button>
          <button class="fmt-btn" onclick="fmt('italic')" title="Italic"><i>I</i></button>
          <button class="fmt-btn" onclick="insertTag('h2')" title="Heading">H2</button>
          <button class="fmt-btn" onclick="insertTag('h3')" title="Sub-heading">H3</button>
          <button class="fmt-btn" onclick="insertList('ul')" title="Bullet list">‚Ä¢ List</button>
          <button class="fmt-btn" onclick="insertList('ol')" title="Numbered list">1. List</button>
          <button class="fmt-btn" onclick="insertTag('blockquote')" title="Quote">‚ùù Quote</button>
          <button class="fmt-btn" onclick="insertHr()" title="Divider">‚îÄ Hr</button>
        </div>
        <textarea id="blogContent" class="form-control with-toolbar" placeholder="Write your investment analysis here. Use the toolbar above for formatting. You can use &lt;strong&gt;, &lt;em&gt;, &lt;h2&gt;, &lt;ul&gt;&lt;li&gt; etc." required oninput="updatePreview()"></textarea>
      </div>
      <p class="content-hint">üí° Tip: Use &lt;strong&gt; for key terms, &lt;h2&gt; for section headings, &lt;ul&gt;&lt;li&gt; for bullet points.</p>
    </div>

    <div class="preview-toggle">
      <input type="checkbox" id="previewToggle" onchange="togglePreview(this)">
      <label for="previewToggle">üëÅ Show live preview</label>
    </div>
    <div class="content-preview" id="contentPreview"></div>

    <!-- ‚îÄ‚îÄ SECTION 3: Media & Links ‚îÄ‚îÄ -->
    <div class="form-section-title">üñºÔ∏è Media &amp; Links</div>

    <div class="form-group">
      <label class="form-label">Cover Image URL</label>
      <input type="url" id="imageUrl" class="form-control" placeholder="https://images.unsplash.com/photo/..." oninput="previewImage(this.value)">
      <div class="img-preview-wrap" id="imgPreviewWrap">
        <img id="imgPreview" class="img-preview" src="" alt="Preview" onerror="this.parentNode.classList.remove('show')">
      </div>
    </div>

    <div class="form-group nj-field">
      <label class="form-label">
        NJ E-Wealth Asset Link
        <span class="nj-badge">üè¶ NJ Portal</span>
      </label>
      <input type="url" id="njLink" class="form-control" placeholder="https://www.njwealth.in/... (direct link to specific fund)">
      <p class="content-hint">This link appears on the "Start SIP" button in the published insight card and modal.</p>
    </div>

    <!-- ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ -->
    <div class="button-group">
      <button onclick="postBlog()" class="btn-primary-custom">
        <i class="fas fa-paper-plane"></i> Publish Insight
      </button>
      <button onclick="resetForm()" class="btn-secondary-custom">Clear</button>
    </div>
  </div>

  <div class="editorial-footer">
    <a href="/admin-dashboard" class="footer-link">‚Üê Lead Dashboard</a>
    &nbsp;&nbsp;¬∑&nbsp;&nbsp;
    <a href="/" class="footer-link">Back to Website</a>
  </div>
</div>

<script>
  /* ‚îÄ‚îÄ Live image preview ‚îÄ‚îÄ */
  let previewTimer;
  function previewImage(url) {
    clearTimeout(previewTimer);
    if (!url) { document.getElementById('imgPreviewWrap').classList.remove('show'); return; }
    previewTimer = setTimeout(() => {
      const img = document.getElementById('imgPreview');
      img.src = url;
      img.onload  = () => document.getElementById('imgPreviewWrap').classList.add('show');
      img.onerror = () => document.getElementById('imgPreviewWrap').classList.remove('show');
    }, 500);
  }

  /* ‚îÄ‚îÄ Formatting toolbar ‚îÄ‚îÄ */
  function getTextarea() { return document.getElementById('blogContent'); }

  function wrapSelection(before, after) {
    const ta    = getTextarea();
    const start = ta.selectionStart;
    const end   = ta.selectionEnd;
    const sel   = ta.value.substring(start, end);
    const replacement = sel ? before + sel + after : before + 'text' + after;
    ta.value = ta.value.substring(0, start) + replacement + ta.value.substring(end);
    ta.focus();
    updatePreview();
  }

  function fmt(type) {
    if (type === 'bold')   wrapSelection('<strong>', '</strong>');
    if (type === 'italic') wrapSelection('<em>', '</em>');
  }

  function insertTag(tag) { wrapSelection(`<${tag}>`, `</${tag}>\n`); }

  function insertList(type) {
    const ta  = getTextarea();
    const ins = `\n<${type}>\n  <li>First point</li>\n  <li>Second point</li>\n  <li>Third point</li>\n</${type}>\n`;
    const pos = ta.selectionStart;
    ta.value  = ta.value.substring(0, pos) + ins + ta.value.substring(pos);
    ta.focus(); updatePreview();
  }

  function insertHr() {
    const ta  = getTextarea();
    const pos = ta.selectionStart;
    ta.value  = ta.value.substring(0, pos) + '\n<hr>\n' + ta.value.substring(pos);
    ta.focus(); updatePreview();
  }

  /* ‚îÄ‚îÄ Live preview ‚îÄ‚îÄ */
  function updatePreview() {
    const content = document.getElementById('blogContent').value;
    const preview = document.getElementById('contentPreview');
    // Convert plain newlines to <p> and render HTML
    const html = content.split('\n\n').map(para => {
      para = para.trim();
      if (!para) return '';
      if (para.startsWith('<h') || para.startsWith('<ul') || para.startsWith('<ol') || para.startsWith('<blockquote') || para.startsWith('<hr')) return para;
      return `<p>${para}</p>`;
    }).join('\n');
    preview.innerHTML = html || '<span style="color:#cbd5e1;">Preview will appear here...</span>';
  }

  function togglePreview(cb) {
    const preview = document.getElementById('contentPreview');
    if (cb.checked) { preview.classList.add('show'); updatePreview(); }
    else              preview.classList.remove('show');
  }

  /* ‚îÄ‚îÄ Form actions ‚îÄ‚îÄ */
  function showMessage(text, type) {
    const msg = document.getElementById('statusMessage');
    msg.textContent = text; msg.className = 'status-message ' + type;
    setTimeout(() => { msg.className = 'status-message'; }, 6000);
  }

  function resetForm() {
    ['blogTitle','blogCategory','imageUrl','refLink','njLink','blogContent'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = '';
    });
    document.getElementById('imgPreviewWrap').classList.remove('show');
    document.getElementById('contentPreview').innerHTML = '';
  }

  async function postBlog() {
    const title    = document.getElementById('blogTitle').value.trim();
    const content  = document.getElementById('blogContent').value.trim();
    const category = document.getElementById('blogCategory').value;
    const image_url      = document.getElementById('imageUrl').value.trim();
    const reference_link = document.getElementById('refLink').value.trim();
    const nj_link        = document.getElementById('njLink').value.trim();

    if (!title || !content) { showMessage('‚ö† Headline and content are required.', 'error'); return; }

    try {
      const response = await fetch('/api/blogs/post', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ title, content, category, image_url, reference_link, nj_link })
      });
      const result = await response.json();
      if (response.ok) {
        showMessage('‚úì Insight published successfully!', 'success');
        resetForm();
      } else {
        if (response.status === 401 || response.status === 403) window.location.href = '/admin-login';
        showMessage('‚ö† Error: ' + (result.error || 'Failed to publish'), 'error');
      }
    } catch (err) {
      showMessage('‚ö† Server connection error. Check backend.', 'error');
    }
  }
</script>

<%- include('../partials/footer') %>
